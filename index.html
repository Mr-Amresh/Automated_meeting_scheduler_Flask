<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Meeting Scheduler</title>
    <style>
        :root {
            --primary: #1E3A8A; /* Navy blue */
            --secondary: #14B8A6; /* Teal */
            --background: #F9FAFB; /* Light gray */
            --card-bg: #FFFFFF; /* White */
            --text: #1F2A44; /* Dark gray */
            --text-muted: #6B7280; /* Muted gray */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', Arial, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #FFFFFF;
            padding: 1.5rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        main {
            display: flex;
            flex: 1;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .container {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chat-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) var(--background);
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: var(--background);
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        .chat-message {
            margin: 0.75rem 0;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .user-message {
            color: var(--primary);
            font-weight: 600;
        }

        .assistant-message {
            color: var(--text-muted);
        }

        .error-message {
            color: #DC2626;
            font-style: italic;
        }

        .mic-button {
            background-color: var(--primary);
            color: #FFFFFF;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            align-self: flex-start;
        }

        .mic-button:hover {
            background-color: #1E40AF;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }

        .mic-button.recording {
            background-color: #DC2626; /* Red */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .spinner {
            display: none;
            border: 4px solid #E5E7EB;
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .confirm-button {
            background-color: var(--secondary);
            color: #FFFFFF;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 0.5rem;
            transition: background-color 0.3s, transform 0.2s;
        }

        .confirm-button:hover {
            background-color: #0D9488;
            transform: translateY(-2px);
        }

        aside.sidebar {
            flex: 1;
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-width: 350px;
            position: sticky;
            top: 20px;
        }

        .sidebar h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button[type="submit"] {
            background-color: var(--secondary);
            color: #FFFFFF;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
        }

        button[type="submit"]:hover {
            background-color: #0D9488;
            transform: translateY(-2px);
        }

        footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
            color: var(--text-muted);
            font-size: 0.85rem;
            text-align: center;
        }

        footer p {
            margin: 0.25rem 0;
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }

            aside.sidebar {
                max-width: 100%;
                position: static;
            }

            .mic-button {
                width: 100%;
                justify-content: center;
            }

            .confirm-button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üìÖ Agentic Meeting Scheduler</h1>
    </header>
    <main>
        <div class="container">
            <p>Hey there! I'm your friendly AI assistant here to help you schedule meetings with ease. Just talk to me using the microphone, fill out the form, or click 'Confirm Meeting' when ready, and I'll get everything set up on your Google Calendar with email invites.</p>
            <p><strong>Current Date and Time: May 18, 2025, 01:13 PM IST</strong></p>
            <div class="chat-container" id="chatContainer">
                <!-- Chat messages will be appended here -->
            </div>
            <button class="mic-button" id="micButton">
                <span>üéôÔ∏è Record Meeting Details</span>
                <div class="spinner" id="spinner"></div>
            </button>
        </div>
        <aside class="sidebar">
            <h2>Plan Your Meeting</h2>
            <form id="meetingForm">
                <div class="form-group">
                    <label for="meetingDate">Pick a Date (Optional)</label>
                    <input type="date" id="meetingDate" name="meetingDate" min="2025-05-18">
                </div>
                <div class="form-group">
                    <label for="meetingTime">Choose a Time (Optional)</label>
                    <input type="time" id="meetingTime" name="meetingTime">
                </div>
                <div class="form-group">
                    <label for="timezone">Timezone (Optional)</label>
                    <select id="timezone" name="timezone">
                        <option value="Asia/Kolkata">Asia/Kolkata</option>
                        <!-- Additional timezones populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="meetingTitle">Meeting Title (Optional)</label>
                    <input type="text" id="meetingTitle" name="meetingTitle" placeholder="e.g., Team Catch-Up">
                </div>
                <div class="form-group">
                    <label for="meetingDescription">Description (Optional)</label>
                    <textarea id="meetingDescription" name="meetingDescription" placeholder="e.g., Let‚Äôs talk project updates"></textarea>
                </div>
                <div class="form-group">
                    <label for="meetingAgenda">Agenda (Optional)</label>
                    <textarea id="meetingAgenda" name="meetingAgenda" placeholder="e.g., 1. Milestones\n2. Next Steps"></textarea>
                </div>
                <div class="form-group">
                    <label for="meetingAttendees">Attendees (Optional, comma-separated emails)</label>
                    <input type="text" id="meetingAttendees" name="meetingAttendees" placeholder="e.g., john@example.com, alice@example.com">
                </div>
                <button type="submit">Propose Meeting</button>
            </form>
        </aside>
    </main>
    <footer>
        <p><em>Built with Flask, Google Gemini, Google Calendar API, and Supabase</em></p>
        <p><em>Your go-to for easy, conversational meeting scheduling</em></p>
        <p><em>Date: May 18, 2025</em></p>
        <p><em>Troubleshooting: If your meeting doesn‚Äôt show up, check your Google Calendar‚Äôs primary calendar, timezone, and email notifications. Make sure credentials.json is valid.</em></p>
    </footer>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const micButton = document.getElementById('micButton');
        const spinner = document.getElementById('spinner');
        const meetingForm = document.getElementById('meetingForm');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        let isRecording = false;
        let silenceTimer;

        recognition.continuous = true;
        recognition.interimResults = true;

        // Populate timezone options
        const timezoneSelect = document.getElementById('timezone');
        const timezones = [
            'America/New_York',
            'Europe/London',
            'Australia/Sydney',
            // Add more as needed
        ];
        timezones.forEach(tz => {
            const option = document.createElement('option');
            option.value = tz;
            option.textContent = tz;
            timezoneSelect.appendChild(option);
        });

        // Clean markdown from response
        function cleanMarkdown(text) {
            if (typeof text !== 'string') return text;
            return text
                .replace(/```json\n?|\n?```/g, '') // Remove ```json and ```
                .replace(/```/g, '') // Remove stray ```
                .trim();
        }

        // Confirm meeting via /schedule endpoint
        async function confirmMeeting() {
            try {
                spinner.style.display = 'inline-block';
                const response = await fetch('/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                spinner.style.display = 'none';
                console.log('Schedule response:', data); // Debug response

                if (data.error) {
                    console.error('Error from backend:', data.error);
                    const errorMessage = cleanMarkdown(data.error);
                    const errorChat = [...(data.chat_history || []), {
                        role: 'Assistant',
                        message: `Error: ${errorMessage}`
                    }];
                    updateChat(errorChat);
                    alert(errorMessage);
                } else if (data.chat_history && Array.isArray(data.chat_history)) {
                    updateChat(data.chat_history);
                } else if (data.message) {
                    const cleanedMessage = cleanMarkdown(data.message);
                    const fallbackChat = [...(data.chat_history || []), {
                        role: 'Assistant',
                        message: cleanedMessage || 'No valid response received.'
                    }];
                    updateChat(fallbackChat);
                } else {
                    console.error('Invalid response format:', data);
                    updateChat([{
                        role: 'Assistant',
                        message: 'Oops, something went wrong. Please try again.'
                    }]);
                    alert('Failed to confirm meeting. Please try again.');
                }
            } catch (error) {
                spinner.style.display = 'none';
                console.error('Fetch error:', error);
                updateChat([{
                    role: 'Assistant',
                    message: 'Failed to confirm meeting. Please check your connection and try again.'
                }]);
                alert('Failed to confirm meeting. Please try again.');
            }
        }

        // Update chat UI
        function updateChat(messages) {
            chatContainer.innerHTML = '';
            if (!Array.isArray(messages) || messages.length === 0) {
                const div = document.createElement('div');
                div.className = 'chat-message error-message';
                div.innerHTML = '<strong>Assistant</strong>: No messages to display. Please try again.';
                chatContainer.appendChild(div);
                return;
            }
            messages.forEach(msg => {
                if (msg && typeof msg === 'object' && msg.role && msg.message) {
                    const div = document.createElement('div');
                    div.className = `chat-message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}`;
                    const cleanedMessage = cleanMarkdown(msg.message);
                    console.log('Rendering message:', cleanedMessage); // Debug
                    div.innerHTML = `<strong>${msg.role === 'user' ? 'You' : 'Assistant'}</strong>: ${cleanedMessage || 'Empty response received.'}`;
                    
                    // Add Confirm button for meeting proposals
                    if (msg.role === 'Assistant' && cleanedMessage.includes("Just say 'Confirm the meeting'")) {
                        const confirmButton = document.createElement('button');
                        confirmButton.className = 'confirm-button';
                        confirmButton.textContent = 'Confirm Meeting';
                        confirmButton.onclick = confirmMeeting;
                        div.appendChild(confirmButton);
                    }
                    
                    chatContainer.appendChild(div);
                } else {
                    console.warn('Invalid message format:', msg);
                }
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Send input to backend
        async function sendInput(input) {
            try {
                spinner.style.display = 'inline-block';
                const response = await fetch('/transcribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input })
                });
                const data = await response.json();
                spinner.style.display = 'none';
                console.log('Backend response:', data); // Debug response

                // Handle response
                if (data.error) {
                    console.error('Error from backend:', data.error);
                    const errorMessage = cleanMarkdown(data.error);
                    const errorChat = [...(data.chat_history || []), {
                        role: 'Assistant',
                        message: `Error: ${errorMessage}`
                    }];
                    updateChat(errorChat);
                    alert(errorMessage);
                } else if (data.chat_history && Array.isArray(data.chat_history)) {
                    updateChat(data.chat_history);
                } else if (data.message) {
                    // Fallback to message if chat_history is missing
                    const cleanedMessage = cleanMarkdown(data.message);
                    const fallbackChat = [...(data.chat_history || []), {
                        role: 'Assistant',
                        message: cleanedMessage || 'No valid response received.'
                    }];
                    updateChat(fallbackChat);
                } else {
                    console.error('Invalid response format:', data);
                    updateChat([{
                        role: 'Assistant',
                        message: 'Oops, something went wrong. Please try again.'
                    }]);
                    alert('Failed to update chat. Please try again.');
                }
            } catch (error) {
                spinner.style.display = 'none';
                console.error('Fetch error:', error);
                updateChat([{
                    role: 'Assistant',
                    message: 'Failed to process input. Please check your connection and try again.'
                }]);
                alert('Failed to process input. Please try again.');
            }
        }

        // Handle speech recognition
        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            if (interimTranscript) {
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(() => {
                    recognition.stop();
                    micButton.classList.remove('recording');
                    micButton.querySelector('span').textContent = 'üéôÔ∏è Record Meeting Details';
                    isRecording = false;
                    sendInput(interimTranscript);
                }, 5000); // 5-second pause
            }
        };

        recognition.onend = () => {
            if (isRecording) {
                recognition.start();
            }
        };

        micButton.addEventListener('click', () => {
            if (isRecording) {
                recognition.stop();
                micButton.classList.remove('recording');
                micButton.querySelector('span').textContent = 'üéôÔ∏è Record Meeting Details';
                isRecording = false;
            } else {
                recognition.start();
                micButton.classList.add('recording');
                micButton.querySelector('span').textContent = 'üéôÔ∏è Stop Recording';
                isRecording = true;
            }
        });

        // Handle form submission
        meetingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(meetingForm);
            const date = formData.get('meetingDate') || '2025-05-18';
            const time = formData.get('meetingTime') || '09:00';
            const timezone = formData.get('timezone') || 'Asia/Kolkata';
            const title = formData.get('meetingTitle') || 'Meeting';
            const description = formData.get('meetingDescription') || '';
            const agenda = formData.get('meetingAgenda') || '';
            const attendees = formData.get('meetingAttendees') ? formData.get('meetingAttendees').split(',').map(email => email.trim()).filter(email => email) : [];
            const input = `Proposed meeting: ${title} on ${date} ${time} ${timezone} with ${attendees.join(', ') || 'no attendees'}`;
            await sendInput(input);
        });
    </script>
</body>
</html>
